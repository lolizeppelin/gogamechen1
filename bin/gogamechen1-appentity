#!/usr/bin/python
# -*- encoding: utf-8 -*-
import logging
import time
import sys

from simpleutil.config import cfg
from simpleutil.config import types
from simpleutil.utils import table
from simpleutil.utils import timeutils

from goperation.manager import common as manager_common
from goperation.api.client.config import client_opts
from goperation.api.client.config import index_opts
from goperation.api.client import ManagerClient

from goperation.api.client.utils import prepare_results
from goperation.api.client.utils import wait_finish
from goperation.api.client.utils import p_asyncrequest

from gogamechen1 import common
from gogamechen1.api.client import GogameChen1DBClient

CONF = cfg.CONF

timeout_opt = cfg.IntOpt('timeout',
                         default=30,
                         help='Send file/Upgrade/Uploade timeout')

entity_opt = cfg.IntOpt('entity',
                        short='e',
                        required=True,
                        help='Target objtype entity')

group_opt = cfg.IntOpt('group_id', required=True,
                       short='g', help='objtype game group')

objtype_opt = cfg.StrOpt('objtype',
                         required=True,
                         short='o', choices=['gamesvr', 'loginsvr', 'publicsvr'],
                         default='gamesvr',
                         help='Game objtype objfile for')

subtype_opt = cfg.StrOpt('subtype',
                         required=True,
                         short='s',
                         choices=['datadb', 'logdb', 'appfile'],
                         help='Game subtype objfile for')

agent_opt = cfg.IntOpt('agent',
                       short='a',
                       min=1,
                       help='Game install agent, if not set, auto select'
                       )

zone_opt = cfg.StrOpt('zone',
                      default='all',
                      regex='^[a-z][a-z0-9]+$',
                      help='Agent zone mark defalut all')

appfile_opt = cfg.StrOpt('appfile',
                         required=True,
                         short='f',
                         help='Game appfile file uuid')

datadb_opt = cfg.IntOpt('datadb',
                        short='d',
                        min=1,
                        help='Game data database id')

opentime_opt = cfg.IntOpt('opentime',
                          required=True,
                          default=int(time.time()),
                          short='t',
                          help='Game server opentime time')

area_name_opt = cfg.StrOpt('name',
                           required=True,
                           short='n',
                           help='Game server area name')

logdb_opt = cfg.IntOpt('logdb',
                       short='l',
                       min=1,
                       help='Game log database id')

cross_opt = cfg.IntOpt('cross',
                       short='c',
                       help='Game server cross id, if not set auto select')


one_opts = [group_opt, objtype_opt, entity_opt]

create_opts = [group_opt, objtype_opt,
               agent_opt, zone_opt,
               appfile_opt,
               datadb_opt]

gamesvr_create_opt = [area_name_opt, logdb_opt, area_name_opt, opentime_opt, cross_opt]

areas_opt = cfg.ListOpt('areas',
                        required=True,
                        item_type=types.String(regex=manager_common.ENABLEIDS),
                        help='Target areas id list, value like 1-2,3,4,5, all means all')

stop_opt = cfg.BoolOpt('kill',
                       default=False,
                       help='Stop process with kill options when call stop')


def _objtype():
    _opt = objtype_opt
    prefixs = ['--%s' % _opt.name]
    if _opt.short:
        prefixs.append('-%s' % _opt.short)
    choices = _opt.type.choices
    index = 0
    for i, arg in enumerate(sys.argv):
        if arg in prefixs:
            index = i + 1
    if not index:
        objtype = _opt.default
    else:
        objtype = sys.argv[index]
    if choices and objtype not in choices:
        raise ValueError('objtype value not in %s' % str(choices))
    return objtype


def client(session=None):
    return GogameChen1DBClient(httpclient=ManagerClient(url=CONF.gcenter, port=CONF.gcenter_port,
                                                        retries=CONF.retries, timeout=CONF.apitimeout,
                                                        token=CONF.trusted, session=session))


def list():
    CONF.register_cli_opts(index_opts)
    CONF.register_cli_opt(group_opt)
    CONF.register_cli_opt(objtype_opt)
    CONF(project='cmd')
    _client = client()
    code, result, data = prepare_results(_client.appentitys_index, CONF.group_id, CONF.objtype)
    if code:
        print('\033[1;31;40m')
        print 'Fail, code %d, result %s' % (code, result)
        if data:
            print data
        print('\033[0m')
        sys.exit(1)
    entity_heads = ['group_id', 'entity', 'agent_id', 'status', 'objtype']
    if CONF.objtype == common.GAMESERVER:
        entity_heads.append('opentime')
    print '\033[1;32;40m\r',
    print 'List %s entitys success' % CONF.objtype
    print 'status DELETED:-2  UNACTIVE:-1  ACTIVE:0',
    print '\033[0m'
    tb = table.PleasantTable(ident=0, columns=entity_heads, counter=True)
    for appentity in data:
        row = [appentity.get('group_id'), appentity.get('entity'), appentity.get('agent_id'),
               appentity.get('status'), appentity.get('objtype')
               ]
        if CONF.objtype == common.GAMESERVER:
            row.append(timeutils.unix_to_iso(appentity.get('opentime')))
        tb.add_row(row)
    print tb.pformat()


def create():
    objtype = _objtype()
    CONF.register_cli_opts(create_opts)
    if objtype == common.GAMESERVER:
        CONF.register_cli_opts(gamesvr_create_opt)

    CONF(project='cmd')
    _client = client()

    databases = dict()
    body = dict(appfile=CONF.appfile)

    if CONF.agent:
        body.setdefault('agent_id', CONF.agent)

    if CONF.zone:
        body.setdefault('zone', CONF.zone)

    if CONF.datadb:
        databases.setdefault('datadb', CONF.datadb)

    if objtype == common.GAMESERVER:
        body.setdefault('areaname', CONF.name)
        body.setdefault('opentime', CONF.opentime)
        if CONF.cross:
            body.setdefault('cross_id', CONF.cross)
        if CONF.logdb:
            databases.setdefault('logdb', CONF.logdb)

    if databases:
        body.setdefault('database', databases)

    code, result, data = prepare_results(_client.appentitys_create, CONF.group_id, CONF.objtype, body)
    if code:
        print('\033[1;31;40m')
        print 'Fail, code %d, result %s' % (code, result)
        if data:
            print data
        print('\033[0m')
        sys.exit(1)
    print '\033[1;32;40m\r',
    print 'Create %s entity success' % objtype
    print '\033[0m'
    appentity = data[0]
    databases = appentity.get('databases')
    print 'group id: %d' % CONF.group_id,
    print 'agent id: %d' % appentity.get('agent_id'),
    print 'objtype: %s' % appentity.get('objtype')
    if objtype == common.GAMESERVER:
        print 'opentime: %d' % timeutils.unix_to_iso(CONF.opentime)
        print 'area id: %d' % appentity.get('area_id')
        print 'area name: %s' % CONF.name
    print '-------------database info-------------'
    for subtype in databases:
        database = databases[subtype]
        print 'host: %s' % database.get('host')
        print 'port: %d' % database.get('port')
        print 'schema: %s' % database.get('schema')
        print 'user: %s' % database.get('user')
        print 'passwd: %s' % database.get('passwd')
        print 'ro_user: %s' % database.get('ro_user')
        print 'ro_passwd: %s' % database.get('ro_passwd')
        print 'character_set: %s' % database.get('character_set')
        print 'database_id: %d' % database.get('database_id')
        print 'quote_id: %d' % database.get('quote_id')

def show():
    CONF.register_cli_opts(one_opts)
    CONF(project='cmd')
    _client = client()
    code, result, data = prepare_results(_client.appentity_show, CONF.group_id, CONF.objtype, CONF.entity)
    if code:
        print('\033[1;31;40m')
        print 'Fail, code %d, result %s' % (code, result)
        if data:
            print data
        print('\033[0m')
        sys.exit(1)
    appentity = data[0]
    metadata = appentity.get('metadata')
    print '\033[1;32;40m\r',
    print 'Show package success'
    print 'status DELETED:-2  UNACTIVE:-1  ACTIVE:0',
    print '\033[0m'
    print 'status: %d' % appentity.get('status')
    print 'group id: %s' % appentity.get('group_id')
    print 'objtype: %s' % appentity.get('objtype')
    print 'entity: %d' % appentity.get('entity')
    print 'ports: %s' % ','.join(map(str, appentity.get('ports')))
    print 'local_ip: %s' % metadata.get('local_ip')
    print 'external_ips: %s' % str(metadata.get('external_ips'))
    if appentity.get('objtype') == common.GAMESERVER:
        print 'versions: %s' % str(appentity.get('versions'))
        print '--------------areas  info--------------'
        for area in appentity.get('areas'):
            print 'area id: %d | areaname: %s' % (area['area_id'], area['areaname'])
    print '-------------database info-------------'
    for database in appentity.get('databases'):
        print 'subtype: %s' % database.get('subtype')
        print 'schema: %s' % database.get('schema')
        print 'host: %s' % database.get('host')
        print 'port: %d' % database.get('port')
        print 'ro_user: %s' % database.get('ro_user')
        print 'ro_passwd: %s' % database.get('ro_passwd')
        print 'database id: %d' % database.get('database_id')
        print 'quote id: %d' % database.get('quote_id')
        print '---------------------------------------'


def delete():
    CONF.register_cli_opts(one_opts)
    CONF(project='cmd')
    _client = client()
    code, result, data = prepare_results(_client.appentity_delete, CONF.group_id, CONF.objtype, CONF.entity)
    if code:
        print('\033[1;31;40m')
        print 'Fail, code %d, result %s' % (code, result)
        if data:
            print data
        print('\033[0m')
        sys.exit(1)
    appentity = data[0]
    print('\033[1;32;40m')
    print 'Delete entity success'
    print('\033[0m')


def async(action):
    objtype = _objtype()
    CONF.register_cli_opt(timeout_opt)
    if objtype == common.GAMESERVER:
        CONF.register_cli_opt(group_opt)
        CONF.register_cli_opt(objtype_opt)
        CONF.register_cli_opt(areas_opt)
    else:
        CONF.register_cli_opts(one_opts)
    if action == 'stop':
        CONF.register_cli_opt(stop_opt)

    CONF(project='cmd')
    if objtype == common.GAMESERVER:
        target = ','.join(CONF.areas)
    else:
        target = CONF.entity
    _client = client()
    _func = getattr(_client, 'appentity_%s' % action)
    if not _func:
        raise AttributeError
    timeout = CONF.timeout
    if not timeout:
        timeout = 30
    now = int(time.time())
    body = dict(request_time=now,
                finishtime=now + timeout)
    if action == 'stop':
        if CONF.kill:
            body.setdefault('kill', CONF.kill)
    code, result, data = prepare_results(_func,
                                         CONF.group_id, CONF.objtype, target, body=body)
    asyncrequest = data[0]
    request_id = asyncrequest.get('request_id')
    sleep = asyncrequest.get('finishtime') - now
    dead = asyncrequest.get('deadline') - now
    print '%s % request %s has been sended' % (objtype, action, request_id)
    print 'Result will respon after %d, dead after %d' % (sleep, dead)
    if not wait_finish(_client, asyncrequest):
        print('\033[1;31;40m')
        print 'Async request not finish after deadline'
        print('\033[0m')
        sys.exit(1)
    p_asyncrequest(_client, request_id=request_id, details=True)


def start():
    async('start')


def stop():
    async('stop')


def status():
    async('status')


def flushconfig():
    async('flushconfig')


def main():
    FUNCS = ['list', 'create', 'show', 'delete',
             'start', 'stop', 'status', 'flushconfig']
    try:
        func = sys.argv.pop(1)
        if func not in FUNCS:
            raise ValueError
    except (IndexError, ValueError):
        print 'action is: %s' % '  '.join(FUNCS)
        print 'use -h for help'
        sys.exit(1)
    func = eval(func)
    logging.basicConfig(level=logging.WARN)
    CONF.register_cli_opts(client_opts)
    func()


if __name__ == '__main__':
    main()
